# CommuCat CLI Client

Интерактивный консольный клиент для протокола CCP-1. Интерфейс оформлен в духе k9s: списки каналов, журналы событий и поле ввода команд/сообщений.

## Подготовка профиля
1. Создайте профиль и ключи устройства:
   ```bash
   commucat-cli-client init \
     --server https://example.org:8443 \
     --domain example.org
   ```
   Параметры `--pattern`, `--prologue`, `--tls-ca`, `--server-static` и `--traceparent` задаются при необходимости.
2. Скрипт выводит публичный ключ. Зарегистрируйте устройство на сервере:
   ```bash
   commucat-cli rotate-keys <device_id>
   ```
3. Конфигурация сохраняется в `~/.config/commucat/client.json` (измените переменную `COMMUCAT_CLIENT_HOME`, чтобы указать другой путь).

## Запуск клиента
```
commucat-cli-client tui
```
Клиент открывает полноэкранный интерфейс. Горячие клавиши:
- `:` — переход к вводу команды.
- `Tab` — переключение между каналами.
- `Esc` — очистка ввода.
- `Ctrl+C` или `F10` — выход.

## Команды (вводятся с префиксом `:`)
- `connect` — установить соединение с сервером.
- `disconnect` — закрыть активную сессию.
- `join <channel_id> <member1,member2,...>` — присоединиться к каналу и объявить участников.
- `relay <channel_id> <member1,member2,...>` — то же, но с флагом принудительного релэя.
- `leave <channel_id>` — покинуть канал.
- `channel <channel_id>` — переключить активный канал.
- `presence <state>` — отправить Presence-фрейм (например, `presence away`).
- `export` — вывести ключи устройства.
- `clear` — очистить историю сообщений.
- `help` — краткая справка.
- `quit` — завершить работу.

Сообщения отправляются в активный канал простым вводом текста без двоеточия. В окне сообщений отображаются входящие (`<`), исходящие (`>`) и системные (`*`) события. История ограничена 200 записями на канал.

## Борьба с самоподписанными сертификатами
- Укажите путь к корневому сертификату: `--tls-ca /path/to/ca.pem`.
- Лабораторный режим: `--insecure` (используется только для тестов).

## Troubleshooting
- Проверьте, что устройство добавлено в PostgreSQL (`user_device`).
- Убедитесь, что прокси/балансировщик пропускает HTTP/2 и TLS 1.3.
- Включите логирование: `RUST_LOG=debug commucat-cli-client tui`.

## Быстрый сценарий
```bash
# подготовка профиля
commucat-cli-client init --server https://relay.local:8443 --domain relay.local --insecure --force

# регистрация на целевом сервере
commucat-cli rotate-keys device-1730000000000

# запуск интерфейса
commucat-cli-client tui
:connect
:join 42 device-1730000000000,peer@example.org
hello, world!
```
